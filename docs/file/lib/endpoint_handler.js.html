<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/endpoint_handler.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="git@github.com:hoist/endpoint.hoi.io.git">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div data-ice="classWrap">
  <h2>Class</h2>
  <ul>
    
  <li data-ice="classDoc"><span><a href="class/lib/endpoint_handler.js~EndpointHandler.html">EndpointHandler</a></span></li>
<li data-ice="classDoc"><span><a href="class/lib/router.js~Router.html">Router</a></span></li>
<li data-ice="classDoc"><span><a href="class/lib/server.js~Server.html">Server</a></span></li>
</ul>
</div>



<div data-ice="functionWrap">
  <h2><a href="function/">Function</a></h2>
  <ul>
    
  <li data-ice="functionDoc"><span><a href="function/index.html#static-function-routeFromPath">routeFromPath</a></span></li>
</ul>
</div>






</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/endpoint_handler.js</h1>
<pre class="source-code line-number"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;
import errors from &apos;@hoist/errors&apos;;
import logger from &apos;@hoist/logger&apos;;
import Boom from &apos;boom&apos;;
import {
  routeFromPath
}
from &apos;./url_helpers&apos;;
import {
  Publisher
}
from &apos;@hoist/broker&apos;;
import {
  Organisation,
  Application,
  Event
}
from &apos;@hoist/model&apos;;
import {
  clone,
  isObject,
  extend
}
from &apos;lodash&apos;;
import uuid from &apos;uuid&apos;;

/**
 * class to handle incoming requests
 */

class EndpointHandler {
  /**
   * create new handler
   */
  constructor() {
    this._logger = logger.child({
      cls: this.constructor.name
    });
    this._publisher = new Publisher();
  }

  /**
   * handle incoming requests and turn them into events
   * @returns {Promise}
   */
  onRequest(req, reply) {
    this._logger.info(&apos;got a webhook request&apos;);
    return Organisation.findOneAsync({
        slug: req.params.orgSlug
      }).then((organisation) =&gt; {
        if (!organisation) {
          throw new errors.model.NotFoundError();
        }
        return Application.findOneAsync({
          slug: req.params.appSlug,
          organisation: organisation._id
        });
      }).then((application) =&gt; {
        if (!application) {
          throw new errors.model.NotFoundError();
        }
        if ((!application.settings.live) || (!application.settings.live.endpoints)) {
          throw new errors.Http404Error(&apos;No Endpoint Found&apos;);
        }
        this._logger.info(&apos;found org and app&apos;);
        req.params.endpoint = &apos;/&apos; + req.params.endpoint;
        return Promise.resolve(routeFromPath(application.settings.live.endpoints, req.method, req.params.endpoint))
          .then((route) =&gt; {
            if (!route) {
              throw new errors.Http404Error(&apos;No Endpoint Found&apos;);
            }
            this._logger.info(&apos;got an endpoint&apos;);
            var payload = clone(route, true);
            delete payload.event;
            delete payload.method;
            delete payload.authenticate;
            if (req.method.toLowerCase() === &apos;post&apos;) {
              if (isObject(req.payload)) {
                payload = extend(payload, req.payload);
              }
            }

            payload._request = {
              body: req.payload,
              headers: req.headers,
              url: req.params.endpoint,
              method: req.method
            };

            var queryString = req.url.search;

            if (queryString) {
              payload._request.queryString = queryString;
              payload._request.query = req.url.query;
            }

            delete payload._request.headers.host;
            this._logger.info(&apos;building event&apos;);
            var ev = new Event({
              eventId: uuid.v4().split(&apos;-&apos;).join(&apos;&apos;),
              applicationId: application._id,
              eventName: route.event,
              environment: &apos;live&apos;,
              correlationId: require(&apos;uuid&apos;).v4(),
              payload: payload
            });
            return ev;
          });
      })
      .then((event) =&gt; {
        this._logger.info({
          event: event
        }, &apos;sending event to broker&apos;);

        return this._publisher.publish(event)
          .then(() =&gt; {
            return event;
          });
      })
      .then((event) =&gt; {
        this._logger.info(&apos;sending reply&apos;);
        var response = reply(event.toObject());
        response.header(&apos;x-hoist-cid&apos;, event.correlationId);
        response.header(&apos;x-hoist-eid&apos;, event.eventId);
        response.statusCode = 201;
      }).catch((err) =&gt; {
        this._logger.error(err);
        if (!errors.isHoistError(err)) {
          console.log(err);
          this._logger.alert(err);
          err = new errors.HoistError();
        }
        this._logger.info(&apos;sending error reply&apos;);
        reply(Boom.wrap(err, parseInt(err.code)));
      });
  }
}


export default EndpointHandler;
</code></pre>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.1.2)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
